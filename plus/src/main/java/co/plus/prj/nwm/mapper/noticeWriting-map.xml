<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.plus.prj.nwm.mapper.NoticeWritingMapper">
	<!-- 전체 메뉴 -> 내 게시물 목록 -->
	<select id="myPost"
		resultType="co.plus.prj.nwm.vo.NoticeWritingVO">
		select b.*, a.name, a.co_url, c.prj_ttl, 
		case when noti_knd = 'task' then ( select tsk_prgs from task where noti_id
		= b.noti_id)
		when noti_knd = 'subtask' then ( select subtsk_prgs from subtask where
		noti_id = b.noti_id )
		when noti_knd = 'schedule' then ( select TO_CHAR(sche_dttm) from schedule
		where noti_id = b.noti_id )
		when noti_knd = 'todo' then ( select TO_CHAR(RATIO_TO_TODO(b.noti_id))
		from dual )
		end addlist
		from member a, board b, project c
		where b.prj_id = c.prj_id
		and a.mem_id = #{memId}
		and a.mem_id = b.mem_id
		<if test="notiTtl != null and notiTtl != ''">
			and noti_ttl like '%' || #{notiTtl} || '%'
		</if>
	</select>

	
	<resultMap id="tskResult" type="co.plus.prj.nwm.vo.NoticeWritingVO">
		<result property="prjId" column="prj_id" />
		<result property="prjTtl" column="prj_ttl" />
		<collection property="taskDetail" column="{prjId = prj_id}" javaType="java.util.ArrayList" ofType="co.plus.prj.nwm.vo.NoticeWritingVO" select="detailTaskList"/>
	</resultMap>

	<!-- 전체 메뉴 -> 전체 업무 -->
	<select id="allTask" resultMap="tskResult">
		SELECT  prj_id, prj_ttl
		FROM 	project
		where 	prj_knd = 'C'
		and 	co_url = #{coUrl}
		union
		SELECT 	a.prj_id, a.prj_ttl
		FROM 	project a, prj_parti b
		where 	a.prj_knd = 'N'
		and 	a.prj_id = b.prj_id
		and 	b.mem_id = #{memId}
		and 	a.co_url = #{coUrl}
		union
		SELECT  c.prj_id, c.prj_ttl
		FROM	project c, prj_parti d
		where 	c.prj_knd = 'N'
		and 	c.prj_open_perm = 'all'
		and 	c.prj_id = d.prj_id
		and 	c.co_url = #{coUrl}
	</select>

	<select id="detailTaskList" resultType="co.plus.prj.nwm.vo.NoticeWritingVO">
		select  e.*, f.name, g.noti_dttm, g.noti_ttl
            <!-- (select COUNT(*) from subtask
        where noti_id2 = #{notiId2}) as notiId2 -->
		from 	task e, member f, board g
		WHERE 	e.mem_id = f.mem_id
		and 	e.noti_id = g.noti_id
        and     g.prj_id = #{prjId}	
        <!-- 업무 ->ㅣ 업무 명으로 검색 -->
		<if test="notiTtl != null and notiTtl != ''">
			and noti_ttl like '%' || #{notiTtl} || '%'
		</if>
		
		
		<!-- 하위업무도 동시 조회 -->
	<!-- 			from 	task e, member f, board g, subtask t
		WHERE 	e.mem_id = f.mem_id
		and 	e.noti_id = g.noti_id
        and  e.noti_id = t.noti_id2
        and     e.noti_id = 41; -->
	</select>

	<!-- 전체 메뉴 -> 캘린더 -->
	<select id="allSche"
		resultType="co.plus.prj.nwm.vo.NoticeWritingVO">
		select  a.*, b.name
		from 	schedule a, member b
		where 	a.mem_id = b.mem_id
		<!-- 일정 -> 일정 명으로 검색 -->
		<if test="notiTtl != null and notiTtl != ''">
			and noti_ttl like '%' || #{notiTtl} || '%'
		</if>
	</select>
	<!-- 전체 메뉴 -> 파일 -->
	<select id="allFile">
		select  a.noti_ttl, b.txt_file
		from 	board a, text b
		where 	a.noti_id = b.noti_id
		<!-- 파일 -> 게시물 명으로 검색 -->
		<if test="notiTtl != null and notiTtl != ''">
			and noti_ttl like '%' || #{notiTtl} || '%'
		</if>
	</select>

	<!-- 전체 메뉴 -> 북마크 -->
	<select id="bookMarkList"
		resultType="co.plus.prj.nwm.vo.NoticeWritingVO"
		parameterType="co.plus.prj.nwm.vo.NoticeWritingVO">
		select  a.noti_knd, a.noti_ttl, a.noti_dttm, b.*, c.name, c.co_url
		from 	board a, bookmark b, member c
		where 	a.mem_id = b.mem_id
		and 	b.mem_id = c.mem_id
        and 	a.noti_id = b.noti_id
		and 	a.mem_id = #{memId}
		<!-- 북마크 -> 게시물 명으로 검색 -->
		<if test="notiTtl != null and notiTtl != ''">
			and noti_ttl like '%' || #{notiTtl} || '%'
		</if>
	</select>

	<!-- CREATE OR REPLACE FORCE VIEW "PLUS"."BOARD" ("NOTI_ID", "PRJ_ID", "NOTI_KND", 
		"MEM_ID", "NOTI_DTTM", "NOTI_OPEN_PERM", "NOTI_TTL") AS select a."NOTI_ID",a."PRJ_ID",a."NOTI_KND",a."MEM_ID",a."NOTI_DTTM",a."NOTI_OPEN_PERM", 
		b.noti_ttl from notice_writing a, task b where a.noti_id = b.noti_id union 
		all select a."NOTI_ID",a."PRJ_ID",a."NOTI_KND",a."MEM_ID",a."NOTI_DTTM",a."NOTI_OPEN_PERM", 
		c.noti_ttl from notice_writing a, todo c where a.noti_id = c.noti_id union 
		all select a."NOTI_ID",a."PRJ_ID",a."NOTI_KND",a."MEM_ID",a."NOTI_DTTM",a."NOTI_OPEN_PERM", 
		d.noti_ttl from notice_writing a, schedule d where a.noti_id = d.noti_id 
		union all select a."NOTI_ID",a."PRJ_ID",a."NOTI_KND",a."MEM_ID",a."NOTI_DTTM",a."NOTI_OPEN_PERM", 
		e.noti_ttl from notice_writing a, text e where a.noti_id = e.noti_id union 
		all select a."NOTI_ID",a."PRJ_ID",a."NOTI_KND",a."MEM_ID",a."NOTI_DTTM",a."NOTI_OPEN_PERM", 
		f.noti_ttl from notice_writing a, subtask f where a.noti_id = f.noti_id; -->

	<!-- 내 게시물 목록 -> 글 상세보기(팝업) -->
	<select id="myPostTxt"
		resultType="co.plus.prj.nwm.vo.NoticeWritingVO">
		select  a.* , b.co_url, b.prj_id, b.prj_ttl, c.noti_open_perm, c.noti_dttm, d.name
		from 	text a, project b, board c, member d
		where 	a.noti_id = c.noti_id 
		and 	b.prj_id = c.prj_id
		and 	b.co_url = d.co_url
		and 	c.mem_id = d.mem_id
		and 	c.noti_id = #{notiId}
	</select>
	
	<!-- 내 게시물 목록 -> 업무 상세보기(팝업) -->
	<select id="myPostTsk"
		resultType="co.plus.prj.nwm.vo.NoticeWritingVO">
		select  a.*, b.co_url, b.prj_id, b.prj_ttl, c.noti_open_perm, c.noti_dttm, d.name
		from 	task a, project b, board c, member d
		where 	a.noti_id = c.noti_id 
		and 	b.prj_id = c.prj_id
		and 	b.co_url = d.co_url
		and 	c.mem_id = d.mem_id
		and 	c.noti_id = #{notiId}
	</select>
	
	<!-- 내 게시물 목록 -> 하위업무 상세보기(팝업) -->
	<select id="myPostSubtsk"
		resultType="co.plus.prj.nwm.vo.NoticeWritingVO">
		select a.*, b.name, c.subtsk_cntn
		from board a, member b,
		subtask c
		where
		a.mem_id = b.mem_id
		and a.noti_id = c.noti_id
		and a.mem_id
		= #{memId}
	</select>
	
	<!-- 내 게시물 목록 -> 일정 상세보기(팝업) -->
	<select id="myPostSche"
		resultType="co.plus.prj.nwm.vo.NoticeWritingVO">
		select  a.* , b.co_url, b.prj_id, b.prj_ttl, c.noti_open_perm, c.noti_dttm, d.name
		from 	schedule a, project b, board c, member d
		where 	a.noti_id = c.noti_id 
		and 	b.prj_id = c.prj_id
		and 	b.co_url = d.co_url
		and 	c.mem_id = d.mem_id
		and 	c.noti_id = #{notiId}
	</select>
	
	<!-- 내 게시물 목록 -> 할일 상세보기(팝업) -->
	<select id="myPostTodo"
		resultType="co.plus.prj.nwm.vo.NoticeWritingVO">
		select a.noti_dttm, a.noti_open_perm, b.*, c.prj_ttl, c.prj_id, d.name, d.co_url
       from board a, todo b, project c, member d
       where a.noti_id = b.noti_id
       and a.prj_id = c.prj_id
       and c.co_url = d.co_url
       and a.mem_id = d.mem_id
       and a.noti_id = #{notiId}
        
        <!-- select a. noti_knd, b.name, c.*, d.prj_ttl, a.noti_dttm
		from notice_writing
		a, member b, todo c, project d
		where a.mem_id =
		b.mem_id
		and
		a.prj_id=d.prj_id
		and a.noti_id = c.noti_id
		and b.mem_id =
		c.mem_id
		and
		c.noti_id = #{notiId} -->
	</select>



	<!-- 프로젝트 선택 -> 홈 (게시물 목록 조회) -->
	<select id="totalNotice"
		resultType="co.plus.prj.nwm.vo.NoticeWritingVO">
		select a.*, b.name
		from board a, member b
		where a.mem_id = b.mem_id
		and
		a.prj_id = #{prjId}
		<!-- 홈 -> 게시물 명으로 검색 -->
		<if test="notiTtl != null and notiTtl != ''">
			and noti_ttl like '%' || #{notiTtl} || '%'
		</if>
	</select>

	<!-- 프로젝트 선택 후 -> 업무 (1개 프로젝트) -->
	<select id="tskList"
		resultType="co.plus.prj.nwm.vo.NoticeWritingVO">
		select a.*, b.name
		from board a, member b
		where a.mem_id =
		b.mem_id
		and a.noti_knd = 'task'
		and a.prj_id = #{prjId}
	</select>

	<update id="UpdateTxt"
		parameterType="co.plus.prj.nwm.vo.NoticeWritingVO">
		update text
		set noti_ttl = #{notiTtl}, txt_cntn =
		#{txtCntn}, txt_pl = #{txtPl},
		txt_file = #{file}
		where noti_id =
		#{notiId}
	</update>

</mapper>